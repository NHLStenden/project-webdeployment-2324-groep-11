@page "/menu"
@using DieselBrandstofCafe.Components.Models
@using DieselBrandstofCafe.Components.Data
@inject ICustomerService customerService

<div class="menu-page">
    <div class="left-panel">
        <div class="categories">
            <h2>Categories</h2>
            <div class="category-list">
                <div class="category-card"><button class="category-button"><img src=""><span>Beverages</span></button></div>
                <div class="category-card"><button class="category-button"><img src=""><span>Breakfast</span></button></div>
                <div class="category-card"><button class="category-button"><img src=""><span>Sandwiches</span></button></div>
                <div class="category-card"><button class="category-button"><img src=""><span>Soup & Salad</span></button></div>
                <div class="category-card"><button class="category-button"><img src=""><span>Pastry & Desserts</span></button></div>
            </div>
        </div>
        <div class="menu-items">
            <h2>Select Menu</h2>
            <div class="menu-list">
                @if (menuItems == null)
                {
                    <p>Loading...</p>
                }
                else if (!menuItems.Any())
                {
                    <p>No items found.</p>
                }
                else
                {
                    @foreach (var item in menuItems)
                    {
                        <div class="menu-item">
                            <h3>@item.ProductNaam</h3>
                            @* <p>@item.Beschrijving</p> *@
                            <p>€@item.ProductPrijs</p>
                            <div class="invoice-menu-controls">
                                <div class="counter-background">
                                    <button class="decrease-menu-item" @onclick='() => DecreaseAantalProductTemp(item)'>-</button>
                                    <span>@GetTempAantal(item)</span>
                                    <button class="increase-menu-item" @onclick='() => IncreaseAantalProductTemp(item)'>+</button>
                                </div>
                            </div>
                            <button class="add-menu-item" @onclick='() => AddToInvoice(item)'>Add to order</button>
                        </div>
                    }
                }
            </div>
        </div>
    </div>
    <div class="right-panel">
        <div class="order-summary">
            <h2>Invoice</h2>
            <ul>
                @foreach (var invoiceItem in invoiceItems)
                {
                    <li>
                        <div class="invoice-item">
                            <span>@invoiceItem.Product?.ProductNaam (€@invoiceItem.Product?.ProductPrijs)</span>
                            <div class="invoice-item-controls">
                                <span class="product-total">€@(invoiceItem.Product?.ProductPrijs * invoiceItem.AantalProduct)</span>
                                <div class="counter-background">
                                    <button class="decrease-invoice-item" @onclick="() => DecreaseAantalProduct(invoiceItem)">-</button>
                                    <span>@invoiceItem.AantalProduct</span>
                                    <button class="increase-invoice-item" @onclick="() => IncreaseAantalProduct(invoiceItem)">+</button>
                                </div>
                            </div>
                        </div>
                    </li>
                }
            </ul>
            <div class="payment">
                <h5>Payment</h5>
                <p>Sub Total: €@subTotal</p>
                <p>Tax: €@tax</p>
                <p>Total Payment: €@total</p>
                <div class="payment-methods">
                    <button>Card</button>
                    <button>Cash</button>
                    <button>Ideal</button>
                </div>
                <div class="place-order-button-container">
                    <button class="place-order-button">Place Order</button>
                </div>
            </div>
        </div>
        <div class="additional-cards">
            <div class="popular-products">
                <h5>Popular Products</h5>
                <ul>
                    <li>Product 1</li>
                    <li>Product 2</li>
                    <li>Product 3</li>
                </ul>
            </div>
            <div class="sign-up-updates">
                <h5>Sign up for updates</h5>
                <form>
                    <input type="email" placeholder="Enter your email" required>
                    <button type="submit">Sign Up</button>
                </form>
            </div>
        </div>
    </div>
</div>

@code {

    List<Product>? menuItems;
    Dictionary<int, int> tempProductQuantities = new Dictionary<int, int>();

    protected override async Task OnInitializedAsync()
    {
        menuItems = (await customerService.GetProductsAsync()).ToList();
        foreach (var item in menuItems)
        {
            tempProductQuantities[item.ProductID] = 0; // Initialize temporary quantities
        }
    }

    // Lijst om items op de factuur bij te houden
    List<InvoiceItem> invoiceItems = new List<InvoiceItem>();

    decimal subTotal = 0;
    decimal tax = 0;
    decimal total = 0;

    void AddToInvoice(Product product)
    {
        if (tempProductQuantities.TryGetValue(product.ProductID, out int quantity) && quantity > 0)
        {
            var existingItem = invoiceItems.FirstOrDefault(item => item.Product?.ProductID == product.ProductID);
            if (existingItem != null)
            {
                existingItem.AantalProduct += quantity;
            }
            else
            {
                invoiceItems.Add(new InvoiceItem { Product = product, AantalProduct = quantity });
            }
            tempProductQuantities[product.ProductID] = 0; // Reset temporary quantity after adding to invoice
            UpdateTotals();
        }
    }

    // Functie om de hoeveelheid van een tijdelijk item te verhogen
    void IncreaseAantalProductTemp(Product product)
    {
        if (tempProductQuantities.ContainsKey(product.ProductID))
        {
            tempProductQuantities[product.ProductID]++;
        }
    }

    // Functie om de hoeveelheid van een tijdelijk item te verlagen
    void DecreaseAantalProductTemp(Product product)
    {
        if (tempProductQuantities.ContainsKey(product.ProductID) && tempProductQuantities[product.ProductID] > 0)
        {
            tempProductQuantities[product.ProductID]--;
        }
    }

    int GetTempAantal(Product product)
    {
        if (tempProductQuantities.TryGetValue(product.ProductID, out int quantity))
        {
            return quantity;
        }
        return 0;
    }

    // Functie om de hoeveelheid van een item te verhogen
    void IncreaseAantalProduct(InvoiceItem invoiceItem)
    {
        invoiceItem.AantalProduct++;
        UpdateTotals();
    }

    // Functie om de hoeveelheid van een item te verlagen
    void DecreaseAantalProduct(InvoiceItem invoiceItem)
    {
        if (invoiceItem.AantalProduct > 1)
        {
            invoiceItem.AantalProduct--;
        }
        else
        {
            invoiceItems.Remove(invoiceItem);
        }
        UpdateTotals();
    }

    // Functie om een item te verwijderen van de factuur
    void RemoveFromInvoice(InvoiceItem invoiceItem)
    {
        invoiceItems.Remove(invoiceItem);
        UpdateTotals();
    }

    // Functie om totaalbedrag van de factuur te berekenen
    void UpdateTotals()
    {
        subTotal = invoiceItems.Sum(item => (item.Product?.ProductPrijs ?? 0) * item.AantalProduct);
        tax = subTotal * 0.09M; // Eten is volgens mij een btw percentage van 9%
        total = subTotal + tax;
    }

    public class InvoiceItem
    {
        public Product ?Product { get; set; }
        public int AantalProduct { get; set; }
    }
}
