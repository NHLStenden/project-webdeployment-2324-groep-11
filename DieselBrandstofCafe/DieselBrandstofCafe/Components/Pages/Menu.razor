@page "/menu"
@using DieselBrandstofCafe.Components.Models
@using DieselBrandstofCafe.Components.Data
@inject ICustomerService customerService
@inject IProductPerBestelrondeService productPerBestelrondeService
@inject IOrderService orderService
@inject ICategorieService categorieService
@inject NavigationManager navigationManager

<div class="menu-page">
    <div class="left-panel">
        <div class="categories">
            <h2>Categories</h2>
            <div class="category-list">
                @if (categories == null)
                {
                    <p>Loading...</p>
                }
                else
                {
                    @foreach (var category in categories)
                    {
                        <div class="category-card">
                            <button class="category-button" @onclick='() => LoadMenuItems(category.CategorieID)'>
                                <img src="">
                                <span>@category.NaamCategorie</span>
                            </button>
                        </div>
                    }
                }
            </div>
        </div>
        <div class="menu-items">
            <h2>Select Menu</h2>
            <div class="menu-list">
                @if (menuItems == null)
                {
                    <p>Loading...</p>
                }
                else if (!menuItems.Any())
                {
                    <p>No items found.</p>
                }
                else
                {
                    @foreach (var item in menuItems)
                    {
                        <div class="menu-item">
                            <h3>@item.ProductNaam</h3>
                            <p>€@item.ProductPrijs</p>
                            <div class="invoice-menu-controls">
                                <div class="counter-background">
                                    <button class="decrease-menu-item" @onclick='() => DecreaseAantalProductTemp(item)'>-</button>
                                    <span>@GetTempAantal(item)</span>
                                    <button class="increase-menu-item" @onclick='() => IncreaseAantalProductTemp(item)'>+</button>
                                </div>
                            </div>
                            <button class="add-menu-item" @onclick='() => AddToInvoice(item)'>Add to order</button>
                        </div>
                    }
                }
            </div>
        </div>
    </div>

    <div class="right-panel">
        <div class="order-summary">
            <h2>Invoice</h2>
            <ul>
                @foreach (var invoiceItem in invoiceItems)
                {
                    <li>
                        <div class="invoice-item">
                            <span>@invoiceItem.Product?.ProductNaam (€@invoiceItem.Product?.ProductPrijs)</span>
                            <div class="invoice-item-controls">
                                <span class="product-total">€@(invoiceItem.Product?.ProductPrijs * invoiceItem.AantalProduct)</span>
                                <div class="counter-background">
                                    <button class="decrease-invoice-item" @onclick="() => DecreaseAantalProduct(invoiceItem)">-</button>
                                    <span>@invoiceItem.AantalProduct</span>
                                    <button class="increase-invoice-item" @onclick="() => IncreaseAantalProduct(invoiceItem)">+</button>
                                </div>
                            </div>
                        </div>
                    </li>
                }
            </ul>
            <div class="payment">
                <h5>Payment</h5>
                <p>Sub Total: €@subTotal</p>
                <p>Tax: €@tax</p>
                <p>Total Payment: €@total</p>
                <div class="payment-methods">
                    <button>Card</button>
                    <button>Cash</button>
                    <button>Ideal</button>
                </div>
                <div class="place-order-button-container">
                    <button class="place-order-button" @onclick="PlaceOrder">Place Order</button>
                </div>
            </div>
        </div>
        <div class="additional-cards">
            <div class="popular-products">
                <h5>Popular Products</h5>
                <ul>
                    <li>Product 1</li>
                    <li>Product 2</li>
                    <li>Product 3</li>
                </ul>
            </div>
            <div class="sign-up-updates">
                <h5>Sign up for updates</h5>
                <form>
                    <input type="email" placeholder="Enter your email" required>
                    <button type="submit">Sign Up</button>
                </form>
            </div>
        </div>
    </div>
</div>


@code {

    List<Product>? menuItems;
    List<Categorie>? categories;
    Dictionary<int, int> tempProductQuantities = new Dictionary<int, int>();

    protected override async Task OnInitializedAsync()
    {
        categories = (await categorieService.GetCategorieënAsync()).ToList();
        await LoadAllMenuItems();
    }

    async Task LoadAllMenuItems()
    {
        menuItems = (await customerService.GetProductsAsync()).ToList();
        InitializeTempQuantities();
    }

    async Task LoadMenuItems(int categoryId)
    {
        menuItems = (await customerService.GetProductsByCategoryAsync(categoryId)).ToList();
        InitializeTempQuantities();
    }

    void InitializeTempQuantities()
    {
        tempProductQuantities = new Dictionary<int, int>();
        foreach (var item in menuItems)
        {
            tempProductQuantities[item.ProductID] = 0;
        }
    }

    void AddToInvoice(Product product)
    {
        if (tempProductQuantities.TryGetValue(product.ProductID, out int quantity) && quantity > 0)
        {
            var existingItem = invoiceItems.FirstOrDefault(item => item.Product?.ProductID == product.ProductID);
            if (existingItem != null)
            {
                existingItem.AantalProduct += quantity;
            }
            else
            {
                invoiceItems.Add(new InvoiceItem { Product = product, AantalProduct = quantity });
            }
            tempProductQuantities[product.ProductID] = 0; // Reset temporary quantity after adding to invoice
            UpdateTotal();
        }
    }

    // Function to increase the quantity of a temporary item
    void IncreaseAantalProductTemp(Product product)
    {
        if (tempProductQuantities.ContainsKey(product.ProductID))
        {
            tempProductQuantities[product.ProductID]++;
        }
    }

    // Function to decrease the quantity of a temporary item
    void DecreaseAantalProductTemp(Product product)
    {
        if (tempProductQuantities.ContainsKey(product.ProductID) && tempProductQuantities[product.ProductID] > 0)
        {
            tempProductQuantities[product.ProductID]--;
        }
    }

    int GetTempAantal(Product product)
    {
        if (tempProductQuantities.TryGetValue(product.ProductID, out int quantity))
        {
            return quantity;
        }
        return 0;
    }

    // Function to increase the quantity of an item
    void IncreaseAantalProduct(InvoiceItem invoiceItem)
    {
        invoiceItem.AantalProduct++;
        UpdateTotal();
    }

    // Function to decrease the quantity of an item
    void DecreaseAantalProduct(InvoiceItem invoiceItem)
    {
        if (invoiceItem.AantalProduct > 1)
        {
            invoiceItem.AantalProduct--;
        }
        else
        {
            invoiceItems.Remove(invoiceItem);
        }
        UpdateTotal();
    }

    // Function to update the totals
    void UpdateTotal()
    {
        subTotal = invoiceItems.Sum(i => i.Product?.ProductPrijs * i.AantalProduct) ?? 0;
        tax = subTotal * 0.09M;
        total = subTotal + tax;
    }

    public async Task PlaceOrder()
    {
        try
        {
            var bestellingId = await orderService.PlaceOrderAsync(invoiceItems);
            Console.WriteLine($"Order placed successfully with ID: {bestellingId}");
            navigationManager.NavigateTo("/ordersuccess");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error placing order: {ex.Message}");
        }
    }

    decimal subTotal = 0;
    decimal tax = 0;
    decimal total = 0;

    List<InvoiceItem> invoiceItems = new List<InvoiceItem>();
}