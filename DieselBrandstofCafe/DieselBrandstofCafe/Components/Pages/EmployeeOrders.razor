@page "/EmployeeOrders"
@using DieselBrandstofCafe.Components.Data
@using DieselBrandstofCafe.Components.Models
@inject IEmployeeService EmployeeService

<div class="container">
    <div class="row text-center">
        <div>
            <div class="h-100">
                <div class="card col-2 justify-content-center card-colour">
                    <h6 class="Text-padding text-colour" style="font-size:large; padding:13px;"><b>All Orders</b></h6>
                </div>
                <div class="card card-colour">
                    <div class="d-flex row card-maxheight">
                        <div style="padding:13px;">
                            <div class="card card-colour2">
                                <div class="row">
                                    <div class="col-2 text-colour2">Order ID</div>
                                    <div class="col-2 text-colour2">(Table ID)</div>
                                    <div class="col-2 text-colour2">Time</div>
                                    <div class="col-2 text-colour2">(Time Elapsed)</div>
                                    <div class="col-2 text-colour2">Status</div>
                                    <div class="col-2 text-colour2">Prijs</div>
                                </div>
                            </div>
                            <br />
                            @foreach (var item in combinedOrders)
                            {
                                <div class="card card-colour2">
                                    <div class="row" @onclick="() => ToggleOrder(item.BestellingID)">
                                        <div class="col-2 text-colour2">@item.BestellingID#</div>
                                        <div class="col-2 text-colour2">@item.TafelID</div>
                                        <div class="col-2 text-colour2">@item.TijdBestelling</div>
                                        <div class="col-2 text-colour2 @GetElapsedTimeClass(item)">@GetElapsedTimeText(item)</div>
                                        <div class="col-2 @GetStatusColorClass(item.StatusBestelling)">@item.StatusBestelling</div>
                                        <div class="col-2 text-colour2">€@item.TotaalPrijs</div>
                                    </div>
                                    @if (item.IsExpanded)
                                    {
                                        <div class="row">
                                            <div class="col-2 text-colour2 text-start">Amt</div>
                                        </div>

                                        <div class="card"></div>

                                        <div class="row">
                                            <div class="col-12">
                                                <ul>
                                                    @foreach (var product in item.Products)
                                                    {
                                                        <li class="text-colour2">@product.ProductNaam - @product.AantalProduct x</li>
                                                    }
                                                </ul>
                                            </div>
                                        </div>
                                        <div class="row text-end">
                                            <button class=" col-1 btn btn-primary btn-sm" style="margin:10px" @onclick="() => MarkAsPaid(item.BestellingID)">Cash</button>
                                            <button class=" col-1 btn btn-primary btn-sm" style="margin:10px" @onclick="() => MarkAsPaid(item.BestellingID)">Card</button>
                                        </div>
                                    }
                                </div>
                                <br />
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private List<OrderWithProducts> bestellingen = new List<OrderWithProducts>();
    private List<OrderWithProducts> newBestellingen = new List<OrderWithProducts>();
    private List<OrderWithProducts> combinedOrders = new List<OrderWithProducts>();
    private List<OrderWithProducts> PendingBestellingen = new List<OrderWithProducts>();

    private Timer? _timer;

    protected override async Task OnInitializedAsync()
    {
        var orders = await EmployeeService.GetOrderHistoryAsync();
        var newOrders = await EmployeeService.GetOrdersByStatusAsync("In Progress");
        var pendingOrders = await EmployeeService.GetOrdersByStatusAsync("Pending");

        bestellingen = orders.Select(order => new OrderWithProducts
            {
                BestellingID = order.BestellingID,
                TijdBestelling = order.TijdBestelling,
                StatusBestelling = order.StatusBestelling,
                TotaalPrijs = order.TotaalPrijs,
                TafelID = order.TafelID,
                Products = new List<ProductPerBestelronde>()
            }).ToList();

        foreach (var order in bestellingen)
        {
            var products = await EmployeeService.GetProductsForOrderAsync(order.BestellingID);
            order.Products.AddRange(products);
        }

        foreach (var order in newBestellingen)
        {
            var products = await EmployeeService.GetProductsForOrderAsync(order.BestellingID);
            order.Products.AddRange(products);
        }

        foreach (var order in PendingBestellingen)
        {
            var products = await EmployeeService.GetProductsForOrderAsync(order.BestellingID);
            order.Products.AddRange(products);
        }

        combinedOrders = PendingBestellingen.Concat(newBestellingen.Concat(bestellingen)).ToList();

        combinedOrders = combinedOrders
            .OrderByDescending(order => order.StatusBestelling == "Pending" || order.StatusBestelling == "In Progress")
            .ThenByDescending(order => order.TijdBestelling)
            .ToList();

        _timer = new Timer(UpdateElapsedTime, null, 0, 60000); // Update every minute
    }

    private void ToggleOrder(int bestellingID)
    {
        var order = combinedOrders.FirstOrDefault(o => o.BestellingID == bestellingID);
        if (order != null)
        {
            order.IsExpanded = !order.IsExpanded;
        }
    }

    private void MarkAsPaid(int bestellingID)
    {
        var order = combinedOrders.FirstOrDefault(o => o.BestellingID == bestellingID);
        if (order != null)
        {
            order.StatusBestelling = "Paid";
        }
    }

    private async void UpdateElapsedTime(object? state)
    {
        await InvokeAsync(StateHasChanged); // Ensure the UI updates
    }

    public class OrderWithProducts
    {
        public int BestellingID { get; set; }
        public DateTime TijdBestelling { get; set; }
        public string? StatusBestelling { get; set; }
        public decimal TotaalPrijs { get; set; }
        public List<ProductPerBestelronde> Products { get; set; } = new();
        public bool IsExpanded { get; set; } = false;
        public int TafelID { get; set; }
    }

    string GetStatusColorClass(string? status)
    {
        return status switch
        {
            "Pending" => "Status-Pending",
            "In Progress" => "Status-Progress",
            "Completed" => "Status-Completed",
            "Served" => "Status-Served",
            "Open" => "Status-Open",
            "Paid" => "Status-Paid",
            _ => "text-muted",
        };
    }

    private string GetElapsedTimeText(OrderWithProducts order)
    {
        var elapsed = DateTime.Now - order.TijdBestelling;
        int totalMinutes = (int)elapsed.TotalMinutes;
        return $"{totalMinutes} min";
    }

    private string GetElapsedTimeClass(OrderWithProducts order)
    {
        var elapsed = DateTime.Now - order.TijdBestelling;

        if (elapsed.TotalMinutes < 15)
        {
            return "elapsed-time-short";
        }
        else if (elapsed.TotalMinutes < 35)
        {
            return "elapsed-time-medium";
        }
        else
        {
            return "elapsed-time-long";
        }
    }
}
